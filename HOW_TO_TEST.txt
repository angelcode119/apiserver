?? HOW TO TEST SINGLE SESSION SYSTEM ??
========================================

?? IMPORTANT: You said both sessions still work. Here's why and how to fix:

COMMON MISTAKES:
================

1. ? Server NOT restarted after code changes
   ? Solution: RESTART server with: python run.py

2. ? Using OLD tokens from before the fix
   ? Solution: DELETE old tokens, login FRESH

3. ? Testing in same browser with tabs (tokens cached)
   ? Solution: Use TWO DIFFERENT BROWSERS or Incognito

4. ? Admin doesn't have current_session_id field in database
   ? Solution: Server restart will migrate automatically


CORRECT TEST PROCEDURE:
=======================

Step 1: RESTART SERVER
----------------------
cd /workspace
python run.py

(Wait for: "? MongoDB connected successfully!")


Step 2: FRESH LOGIN - Device A (Chrome)
----------------------------------------
1. Open Chrome
2. Go to: http://localhost:8765/docs
3. Click "Authorize"
4. Login:
   Username: admin
   Password: 1234567899
5. Copy the token shown
6. Test /auth/me endpoint ? ? Should work


Step 3: FRESH LOGIN - Device B (Firefox or Incognito)
------------------------------------------------------
1. Open Firefox (or Chrome Incognito)
2. Go to: http://localhost:8765/docs
3. Click "Authorize"  
4. Login with SAME admin:
   Username: admin
   Password: 1234567899
5. Test /auth/me endpoint ? ? Should work


Step 4: TEST OLD TOKEN - Back to Device A (Chrome)
---------------------------------------------------
1. Go back to Chrome
2. Test /auth/me endpoint again
3. ? Should FAIL with error:
   "Session expired. Another login detected from different location."


CHECK SERVER LOGS:
==================

When you test, you should see in server logs:

Login from Device A:
?? Session created for admin: xKj3mP9qR2nL5wT8vY1... (updated: 1)

Login from Device B (same admin):
?? Session created for admin: zN6dE8hG7bF4aT1cZ9... (updated: 1)

Device A tries to use old token:
?? Session Check for admin:
   Token session_id: xKj3mP9qR2nL5wT8vY1...
   DB session_id: zN6dE8hG7bF4aT1cZ9...
? REJECT admin: Session mismatch!


IF IT STILL DOESN'T WORK:
==========================

Check these:

1. Server logs show session creation?
   ? If NO: Database not updating

2. Server logs show session check?
   ? If NO: Middleware not running

3. Both tokens have SAME session_id?
   ? If YES: Not actually doing fresh logins

4. Database has current_session_id field?
   ? Check with MongoDB Compass


MANUAL DATABASE CHECK:
=======================

Connect to MongoDB and run:

db.admins.findOne(
  {username: "admin"},
  {username: 1, current_session_id: 1}
)

Should show:
{
  "_id": ObjectId("..."),
  "username": "admin",
  "current_session_id": "xKj3mP9qR2nL5wT8vY1aF4hG7bN0cZ6dE"
}

If current_session_id is missing or null ? Admin needs to login again!


DECODE JWT TOKENS:
==================

Go to https://jwt.io and paste your tokens.

Token A should have:
{
  "sub": "admin",
  "role": "super_admin",
  "session_id": "xKj3mP9qR2...",
  "exp": 1699000000
}

Token B should have DIFFERENT session_id:
{
  "sub": "admin",
  "role": "super_admin",
  "session_id": "zN6dE8hG7b...",  ? DIFFERENT!
  "exp": 1699000000
}

If both tokens have SAME session_id ? You're reusing cached tokens!


FINAL CHECKLIST:
================

? Server restarted after code changes
? Using TWO different browsers (or incognito)
? Fresh logins (not cached tokens)
? Server logs show "Session created"
? Server logs show "Session mismatch" on old token
? Tokens have DIFFERENT session_ids

IF ALL CHECKED AND STILL FAILS:
? Send me the server logs from login attempts
? Show me the decoded JWT tokens from jwt.io
? I'll debug further
