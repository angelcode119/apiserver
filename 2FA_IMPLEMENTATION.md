# ?? Two-Factor Authentication (2FA) Implementation

## ????? ???????

????? 2FA ????? ?????????? ??! ???? ???? ????? ???? ?? ?? OTP 6 ???? ??? ?? ?? ?????? ?????? ?????.

---

## ???? ??? ???????

### ????? 1: ???? ?? Username/Password
```
????? ? POST /auth/login
Body: {
  "username": "admin",
  "password": "1234567899"
}

???? ? ????:
{
  "success": true,
  "message": "OTP code sent to your Telegram...",
  "temp_token": "eyJhbGc...",
  "expires_in": 300
}
```

**???? ???:**
- ??? username/password ?????? ????? ??? ?????
- ??? ???? ????? ?? OTP 6 ???? ?? ?????? ???????
- ?? `temp_token` ???? ??????????? (??? 5 ????? ??????)
- **???? ????? ?????!** ???? ????? 2 ?? ???? ???

### ????? 2: ????? ?? OTP
```
????? ? POST /auth/verify-2fa
Body: {
  "username": "admin",
  "otp_code": "123456",
  "temp_token": "eyJhbGc..."  // ?? ????? 1
}

???? ? ???? (?? ???? ??????):
{
  "access_token": "eyJhbGc...",
  "token_type": "bearer",
  "expires_in": 86400,
  "admin": {
    "username": "admin",
    "email": "admin@example.com",
    ...
  }
}
```

**???? ???:**
- ?? OTP 6 ????? ?? ?? ?????? ??????
- ?? ??? **5 ?????** ??????
- ?????? **3 ???** ???????? ?? ?????? ?????
- ??? ?? ?????? `access_token` ???? ?? ?????? ???????

---

## ???????? ???? ????? ???

### 1. `app/services/otp_service.py`
????? ?????? OTP codes:
- ????? ?? 6 ???? ??????
- ????? ?? ??????? ?? expire time
- ????? ?? OTP
- ??????? ???? (3 ???)
- ??????? ?????? ????? ????? ???

### 2. `app/models/otp_schemas.py`
Schema ??? ????? ?? OTP:
- `OTPRequest`: ??????? ?????
- `OTPVerify`: ????? OTP
- `OTPResponse`: ???? ????? 1
- `OTPVerifyResponse`: ???? ????? 2

### 3. ??????? ?? `app/services/auth_service.py`
????? ??:
- `ENABLE_2FA`: flag ???? ????/??????? ???? 2FA
- `create_temp_token()`: ????? ???? ????
- `verify_temp_token()`: ????? ???? ????

### 4. ??????? ?? `app/main.py`
- `/auth/login`: ???????? ?? - ???? OTP ????????
- `/auth/verify-2fa`: endpoint ???? ???? ????? OTP

### 5. ??????? ?? `app/database.py`
Index ??? ???? ???? collection `otp_codes`:
- `username + used`
- `expires_at` ?? TTL (auto-delete ??? ?? 1 ????)
- `created_at`

---

## ???? ??????? (Frontend/Client)

### ?????? 1: 2FA ???? ??? (???????)

```javascript
// Step 1: Login ?? username/password
const loginResponse = await fetch('/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    username: 'admin',
    password: '1234567899'
  })
});

const loginData = await loginResponse.json();

if (loginResponse.ok) {
  // ?? OTP ?? ?????? ??????? ??
  const tempToken = loginData.temp_token;
  
  // ????? ??? ???? ???? ???? OTP
  const otpCode = prompt("Enter OTP code from Telegram:");
  
  // Step 2: Verify OTP
  const verifyResponse = await fetch('/auth/verify-2fa', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      username: 'admin',
      otp_code: otpCode,
      temp_token: tempToken
    })
  });
  
  const verifyData = await verifyResponse.json();
  
  if (verifyResponse.ok) {
    // ????? ????! ????? access_token
    localStorage.setItem('access_token', verifyData.access_token);
    console.log('Logged in successfully!');
  } else {
    console.error('Invalid OTP:', verifyData.detail);
  }
} else {
  console.error('Invalid credentials');
}
```

### ?????? 2: ??????? ???? 2FA (???????)

??? ???????? ?????? 2FA ?? ??????? ????:

```python
# ?? ???? app/services/auth_service.py
ENABLE_2FA = False  # Change to False
```

?? ??? ?????? endpoint `/auth/login` ??? ??? ??? ?????? ? ???? OTP ????? ??????.

---

## ??????? ??????

???? ????? ????? OTP ?? ?????? ??????? ???? ????:

### 1. ???? 2FA ?? ????? ????

?? ???? `.env`:
```bash
TELEGRAM_2FA_BOT_TOKEN=1234567890:ABC-DEF-TOKEN-HERE
```

### 2. Chat ID ?? ????? ?? ????? ????

```bash
PUT /admin/update/admin
{
  "telegram_2fa_chat_id": "-1001234567890"
}
```

?? ???? ???? ????? ????:
```bash
POST /admin/create
{
  "username": "user1",
  "password": "pass123",
  "telegram_2fa_chat_id": "-1001234567890",
  ...
}
```

---

## ????? ? ??????????

### ? ??????? ??????:

1. **Expire Time:** ???? 5 ????? ???????
2. **??????? ????:** ?????? 3 ??? ???????? ?? ?????? ?????
3. **One-Time Use:** ?? ?? ??? ????? ???? ??????? ???
4. **Temp Token:** ???? ???? ??? 5 ????? ??????
5. **IP Logging:** IP ?? ???? ????? ????
6. **Auto Cleanup:** ????? ????? ??? ?????? ??? ?????

### ?? ?????? ??????:

- ????? 2FA ?? ???? ??? ????? (?? production)
- ???? 2FA ?? ???? ????? ????
- Chat ID ??? ?????? ?? ??????? ??? ?????
- ??????? ???? ?? ?????? ????? ????

---

## API Endpoints

### POST `/auth/login`
**????? 1: ????? username/password ? ????? OTP**

Request:
```json
{
  "username": "admin",
  "password": "1234567899"
}
```

Response (2FA ????):
```json
{
  "success": true,
  "message": "OTP code sent to your Telegram. Please verify to complete login.",
  "temp_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 300
}
```

Response (2FA ???????):
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 86400,
  "admin": { ... }
}
```

---

### POST `/auth/verify-2fa`
**????? 2: ????? ?? OTP ? ?????? access_token**

Request:
```json
{
  "username": "admin",
  "otp_code": "123456",
  "temp_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

Response (????):
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 86400,
  "admin": {
    "username": "admin",
    "email": "admin@example.com",
    "full_name": "Administrator",
    "role": "super_admin",
    "permissions": [...],
    "is_active": true,
    "last_login": "2025-10-31T10:00:00",
    "login_count": 15,
    "created_at": "2025-01-01T00:00:00"
  }
}
```

Response (??????):
```json
{
  "detail": "Invalid or expired OTP code"
}
```

---

## ???????? ???

| ??? | ???? | ??? ?? |
|-----|------|--------|
| `Invalid username or password` | username ?? password ?????? ??? | ??????? ???? ?? ?? ???? |
| `Invalid or expired temporary token` | temp_token ????? ??? ?? ???????? | ?????? login ???? (????? 1) |
| `Invalid or expired OTP code` | ?? OTP ?????? ?? ????? ??? | ?? ???? ??????? ???? |
| `Too many failed attempts` | 3 ??? ?? ?????? ???? | ?? ???? ??????? ???? |
| `OTP code has expired` | ?? 5 ???????? ????? ??? | ?? ???? ??????? ???? |

---

## ??? ????

### ??? ?? curl:

```bash
# Step 1: Login
curl -X POST http://localhost:8765/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"1234567899"}'

# Output:
# {
#   "success": true,
#   "temp_token": "eyJhbGc...",
#   "expires_in": 300
# }

# ??? ?? ?????? ?? ?? ??????:

# Step 2: Verify OTP
curl -X POST http://localhost:8765/auth/verify-2fa \
  -H "Content-Type: application/json" \
  -d '{
    "username":"admin",
    "otp_code":"123456",
    "temp_token":"eyJhbGc..."
  }'

# Output:
# {
#   "access_token": "eyJhbGc...",
#   "token_type": "bearer",
#   "expires_in": 86400,
#   "admin": {...}
# }
```

### ??? ?? Swagger UI:

1. ??? ?? `http://localhost:8765/docs`
2. ???? ?? `/auth/login`
3. Try it out ? Execute
4. ?? OTP ?? ?? ?????? ????
5. ???? ?? `/auth/verify-2fa`
6. ?? ? temp_token ?? ???? ??
7. Execute

---

## Troubleshooting

### ????: ?? OTP ?????? ?????

**?? ??:**
- ? `TELEGRAM_2FA_BOT_TOKEN` ?? `.env` ????? ????
- ? ???? start ??? ?? ???????
- ? `telegram_2fa_chat_id` ????? ???? ????? ????
- ? Chat ID ?? `-` ???? ?????

**??? ????:**
```bash
curl https://api.telegram.org/bot<TOKEN>/sendMessage \
  -d chat_id=<CHAT_ID> \
  -d text="Test OTP: 123456"
```

### ????: temp_token ????? ???? ???? ???

**??? ??:**
- Temp token ??? 5 ????? ??????
- ??????? ?? ?? ???? ????
- ?? ???? ?? ?????? ???? ?? `auth_service.py`

### ????: ?????? 2FA ?? ??????? ???

**??? ??:**
```python
# app/services/auth_service.py
ENABLE_2FA = False
```

---

## ?????

? **2FA ????? ?????????? ??**
? **?? OTP 6 ???? ?? ?????? ?????**
? **?? ????????: username/pass ? OTP ? access_token**
? **???: expire time, ??????? ????, one-time use**
? **???? ??????? ???? ?? ?? flag**

---

**????:** 2.0.0  
**?????:** 2025-10-31  
**?????:** ? ???? ? ????? ???????
