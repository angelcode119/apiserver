# ?? ????? ????? Multi-Bot Telegram

## ? ????? ???? ? ????? ???!

---

## ???? ??? ???????

### ?? ??????:

```
?? ????? ?????:
??? telegram_2fa_chat_id (???? ?????? OTP ?? ???? ?????)
??? telegram_bots (5 ????)
    ??? Bot 1: Device Notifications (??????? ??????/??????)
    ??? Bot 2: SMS Notifications (???????? ????)
    ??? Bot 3: Admin Activity Logs (???????? ???????)
    ??? Bot 4: Login/Logout Logs (???? ? ????)
    ??? Bot 5: Future Use (??????? ?????)

+ ???? 2FA ????? (?? ???? ???? ??? ????????)
```

---

## ?? ????? ???? ?????

### 1?? ????? ??????? (Administrator)

? **???? ?????? ????:**
- ???? `create_default_admin()` ???? ????
- ??? Administrator ???? ?????? ????? ???????
- **5 ???? placeholder** ????? ????? ????
- ???????? placeholder: `ADMIN_BOT1_TOKEN_HERE`, ...
- Chat ID ??? placeholder: `-1001ADMIN1_CHATID`, ...

? **???:**
- Super Admin
- ??? ?????????????? ??? ???????? ?? ???????
- ?? ?????????? ?? ???? ????? ???? (Bot 1-5)

?? **????:** `app/services/auth_service.py:264-303`

---

### 2?? ????? ????

? **?? ???? ???? ?????:**

#### ???? 1: ???? ???? (????)
```json
POST /admin/create
{
  "username": "user1",
  "password": "pass123",
  "email": "user1@example.com"
  // telegram_bots ????
}
```

**?????:**
- ? 5 ???? placeholder ?????? ????? ????
- ???????: `USER1_BOT1_TOKEN_HERE`, ...
- Chat ID ??: `-1001USER11_CHATID`, ...
- ?? ???? ????? ?? `/admin/update` ??????? ?? ????? ???

#### ???? 2: ?? 5 ???? ????
```json
POST /admin/create
{
  "username": "user1",
  "password": "pass123",
  "email": "user1@example.com",
  "telegram_2fa_chat_id": "-1001234567890",
  "telegram_bots": [
    {"bot_id": 1, "bot_name": "user1_devices", "token": "...", "chat_id": "..."},
    {"bot_id": 2, "bot_name": "user1_sms", "token": "...", "chat_id": "..."},
    {"bot_id": 3, "bot_name": "user1_logs", "token": "...", "chat_id": "..."},
    {"bot_id": 4, "bot_name": "user1_auth", "token": "...", "chat_id": "..."},
    {"bot_id": 5, "bot_name": "user1_future", "token": "...", "chat_id": "..."}
  ]
}
```

**?????:**
- ? ????? ?? 5 ???? ????? ????? ????
- ? ???????? ?????????? ?????? ??????

#### ???? 3: ????? ?????? (????? 3 ????)
```json
POST /admin/create
{
  "username": "user1",
  "telegram_bots": [
    {"bot_id": 1, ...},
    {"bot_id": 2, ...},
    {"bot_id": 3, ...}
    // ??? 3 ??!
  ]
}
```

**?????:**
- ? **??? ?????!**
- `HTTP 400: Admin must have exactly 5 telegram bots, got 3`
- ????? ????? ?????

?? **????:** `app/services/auth_service.py:117-137`

---

### 3?? ???? 2FA (?????)

? **?? ????? ??? chat_id:**
- ???? ?????: `TELEGRAM_2FA_BOT_TOKEN` (?? `.env`)
- ?? ????? chat_id ???? ????: `telegram_2fa_chat_id`

? **??????:**
- ????? ?? OTP 6 ???? ???? ?????
- ????? ????? ???? ??????

? **????:**
```
Admin: user1 ? OTP ???? ?? chat_id: -1001111111111
Admin: user2 ? OTP ???? ?? chat_id: -1002222222222
??? ?? ?? ???? ????!
```

?? **????:** `app/services/telegram_multi_service.py:125-153`

---

### 4?? ?????????????

? **???????? ??????:**

| ?????? | ???? | ?????? |
|--------|------|---------|
| Device Registered | Bot 1 | ???? ?????? + Administrator |
| Device Online/Offline | Bot 1 | ???? ?????? + Administrator |
| New SMS | Bot 2 | ???? ?????? + Administrator |
| Command Sent | Bot 3 | ?????? ?? ????? ??? + Administrator |
| Settings Changed | Bot 3 | ????? + Administrator |
| Data Deleted | Bot 3 | ????? + Administrator |
| Admin Login | Bot 4 | ????? + Administrator |
| Admin Logout | Bot 4 | ????? + Administrator |
| Admin Created | Bot 3 | ?????? + Administrator |
| 2FA OTP | ???? 2FA | ??? chat_id ????? |

? **Duplicate Prevention:**
- ??? Administrator ???? ???? ?? ????? ???? ????? ?????????? ????????
- `exclude_username` ?? `_notify_super_admin()`

?? **????:** `app/services/telegram_multi_service.py`

---

### 5?? Administrator (Super Admin)

? **???:**
- ??? ?????????????? ??? ???????? ?? ???????
- ????????? ??? ?? 5 ????:
  ```
  Chat Bot 1 (Administrator): ??? ?????????? ?????????
  Chat Bot 2 (Administrator): ??? SMS ??
  Chat Bot 3 (Administrator): ??? ??????? ????????
  Chat Bot 4 (Administrator): ??? ????/???????
  Chat Bot 5 (Administrator): ?????
  ```

? **????:**
- ????? ????
- ????????? ??? ? ????????????
- ????? ???? (??????? ??? SMS ?? ?? ?????? ? Bot 2)

?? **????:** `app/services/telegram_multi_service.py:377-410`

---

## ?? ??????? ????

### ? Fix ??: Validation ???????

**???:**
```python
if len(telegram_bots) != 5:
    logger.warning("?? Admin created without 5 bots")
# ????? ????? ? ????? ???? ???? ?????? ?
```

**????:**
```python
if len(telegram_bots) == 0:
    # 5 ?? placeholder ????
    telegram_bots = [...]
elif len(telegram_bots) != 5:
    # ??? ???
    raise HTTPException(400, "Must have exactly 5 bots")
```

**?????:**
- ? ?? ?????? ????? 5 ???? ???? (????? ?? placeholder)
- ? ????? ????? ???? ???? ?????
- ? ???????????: ????? ???? ???? ? placeholder ??????

---

## ?? ???????

### ???? ????? ???? ???? (????):
```bash
POST /admin/create
{
  "username": "user1",
  "password": "pass123",
  "email": "user1@example.com",
  "full_name": "User One",
  "role": "admin"
}
```
? 5 ???? placeholder ??????? ????? ????? ??

### ???? ????? ?? ???? (???????):
```bash
POST /admin/create
{
  "username": "user1",
  "password": "pass123",
  "email": "user1@example.com",
  "full_name": "User One",
  "role": "admin",
  "telegram_2fa_chat_id": "-1001234567890",
  "telegram_bots": [
    {"bot_id": 1, "bot_name": "user1_devices", "token": "TOKEN1", "chat_id": "-1001111"},
    {"bot_id": 2, "bot_name": "user1_sms", "token": "TOKEN2", "chat_id": "-1002222"},
    {"bot_id": 3, "bot_name": "user1_logs", "token": "TOKEN3", "chat_id": "-1003333"},
    {"bot_id": 4, "bot_name": "user1_auth", "token": "TOKEN4", "chat_id": "-1004444"},
    {"bot_id": 5, "bot_name": "user1_future", "token": "TOKEN5", "chat_id": "-1005555"}
  ]
}
```
? ???????? ?????????? ???????

### ????? ???????? ?????:
```bash
PUT /admin/update/user1
{
  "telegram_2fa_chat_id": "-1001234567890",
  "telegram_bots": [...]
}
```

---

## ? ?? ???? ?????

- ? ????? multi-bot ?????????? ???
- ? telegram_multi_service ?? ??????? ???????
- ? ????????????? ?? ???????? ???? ????
- ? Administrator ??? ?? ???????
- ? 2FA ?? ???? ????? ??? ??????
- ? Validation ??????? ???? ??
- ? ????? ??????? ?? 5 ???? ????? ????
- ? ????? ???? ???? ???? ? placeholder ??????
- ? ????? ???? ?? ????? ?????? ? ??? ?????
- ? Duplicate prevention ???? Administrator
- ? ??? endpoint ?? ?? telegram_multi_service ??? ???

---

## ?? ?????

**? ????? ????? ??? ???? ? ????? ???????!**

---

## ?? ??????? ?????

- `BOT_SYSTEM_GUIDE.md` - ??????? ???? ????? ???????
- `CONFIGURE_ADMIN_BOTS.md` - ????? ???????? ?????
- `2FA_IMPLEMENTATION.md` - ????? 2FA
- `TELEGRAM_FIX.md` - ???? ???? TELEGRAM_BOTS

---

**?????:** 2025-10-31  
**????:** 2.0.0  
**?????:** ? Production Ready
