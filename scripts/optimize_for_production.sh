#!/bin/bash

#??????????????????????????????????????????????????????????????????????????
# Production Optimization Script
# ???? ?????????? ???? ??? 25,000+ ?????
#??????????????????????????????????????????????????????????????????????????

set -e  # Exit on error

echo "?? Optimizing server for production..."
echo "??????????????????????????????????????????????????????????????"
echo ""

# ??????????????????????????????????????????????????????????????????????????
# 1. Check Prerequisites
# ??????????????????????????????????????????????????????????????????????????

echo "?? Checking prerequisites..."

# Check Python
if ! command -v python3 &> /dev/null; then
    echo "? Python 3 not found. Please install Python 3.8+"
    exit 1
fi
echo "? Python 3: $(python3 --version)"

# Check pip
if ! command -v pip3 &> /dev/null; then
    echo "? pip3 not found. Installing..."
    sudo apt-get install python3-pip -y
fi
echo "? pip3 installed"

# Check MongoDB
if ! command -v mongosh &> /dev/null && ! command -v mongo &> /dev/null; then
    echo "??  MongoDB client not found. Skipping DB checks."
else
    echo "? MongoDB client found"
fi

echo ""

# ??????????????????????????????????????????????????????????????????????????
# 2. Install Dependencies
# ??????????????????????????????????????????????????????????????????????????

echo "?? Installing Python dependencies..."
pip3 install -r requirements.txt

# Install production dependencies
pip3 install gunicorn redis aioredis

echo "? Dependencies installed"
echo ""

# ??????????????????????????????????????????????????????????????????????????
# 3. Create Database Indexes
# ??????????????????????????????????????????????????????????????????????????

echo "?? Creating database indexes..."
python3 scripts/create_indexes.py

echo "? Database indexes created"
echo ""

# ??????????????????????????????????????????????????????????????????????????
# 4. Install and Configure Redis
# ??????????????????????????????????????????????????????????????????????????

echo "?? Checking Redis..."

if ! command -v redis-server &> /dev/null; then
    echo "Installing Redis..."
    sudo apt-get update
    sudo apt-get install redis-server -y
    
    # Configure Redis for production
    sudo sed -i 's/^maxmemory .*/maxmemory 1gb/' /etc/redis/redis.conf
    sudo sed -i 's/^# maxmemory-policy .*/maxmemory-policy allkeys-lru/' /etc/redis/redis.conf
    
    # Start Redis
    sudo systemctl start redis-server
    sudo systemctl enable redis-server
    
    echo "? Redis installed and configured"
else
    echo "? Redis already installed"
    
    # Check if running
    if ! sudo systemctl is-active --quiet redis-server; then
        echo "Starting Redis..."
        sudo systemctl start redis-server
    fi
fi

# Test Redis connection
if redis-cli ping &> /dev/null; then
    echo "? Redis is running"
else
    echo "??  Redis is not responding"
fi

echo ""

# ??????????????????????????????????????????????????????????????????????????
# 5. Install and Configure Nginx (Optional)
# ??????????????????????????????????????????????????????????????????????????

echo "?? Checking Nginx..."

if ! command -v nginx &> /dev/null; then
    read -p "Install Nginx as reverse proxy? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "Installing Nginx..."
        sudo apt-get install nginx -y
        echo "? Nginx installed"
        echo "??  Please configure Nginx manually (see docs/PERFORMANCE_OPTIMIZATION.md)"
    fi
else
    echo "? Nginx already installed"
fi

echo ""

# ??????????????????????????????????????????????????????????????????????????
# 6. Create Directories and Logs
# ??????????????????????????????????????????????????????????????????????????

echo "?? Creating directories..."

mkdir -p logs
mkdir -p tmp
mkdir -p backups

echo "? Directories created"
echo ""

# ??????????????????????????????????????????????????????????????????????????
# 7. Create Systemd Service
# ??????????????????????????????????????????????????????????????????????????

echo "?? Creating systemd service..."

cat > /tmp/parental-control.service << EOF
[Unit]
Description=Parental Control API
After=network.target mongodb.service redis.service
Wants=redis.service

[Service]
Type=notify
User=$USER
WorkingDirectory=$(pwd)
Environment="PATH=$(pwd)/venv/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=$(which gunicorn) app.main:app \\
    --workers 4 \\
    --worker-class uvicorn.workers.UvicornWorker \\
    --bind 0.0.0.0:8000 \\
    --timeout 60 \\
    --keep-alive 5 \\
    --log-level info \\
    --access-logfile logs/access.log \\
    --error-logfile logs/error.log
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo mv /tmp/parental-control.service /etc/systemd/system/
sudo systemctl daemon-reload

echo "? Systemd service created"
echo ""

# ??????????????????????????????????????????????????????????????????????????
# 8. Summary and Next Steps
# ??????????????????????????????????????????????????????????????????????????

echo "??????????????????????????????????????????????????????????????"
echo "? Optimization Complete!"
echo "??????????????????????????????????????????????????????????????"
echo ""
echo "?? What was done:"
echo "   ? Dependencies installed"
echo "   ? Database indexes created"
echo "   ? Redis installed and configured"
echo "   ? Systemd service created"
echo ""
echo "?? To start the server:"
echo "   sudo systemctl start parental-control"
echo "   sudo systemctl enable parental-control"
echo ""
echo "?? Check status:"
echo "   sudo systemctl status parental-control"
echo ""
echo "?? View logs:"
echo "   tail -f logs/access.log"
echo "   tail -f logs/error.log"
echo ""
echo "??  Configuration:"
echo "   ? Workers: 4"
echo "   ? Port: 8000"
echo "   ? Redis: localhost:6379"
echo "   ? MongoDB: localhost:27017"
echo ""
echo "?? For more optimization options, see:"
echo "   docs/PERFORMANCE_OPTIMIZATION.md"
echo ""
echo "?? Recommended next steps:"
echo "   1. Configure environment variables in .env"
echo "   2. Setup Nginx as reverse proxy"
echo "   3. Enable rate limiting in main.py"
echo "   4. Setup monitoring (Prometheus/Grafana)"
echo "   5. Configure backups"
echo ""
echo "?? Ready for 25,000+ users!"
echo "??????????????????????????????????????????????????????????????"
